name: Test Suite

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-timeout httpx

      - name: Set up test environment
        run: |
          cp .env.example .env || echo "ANTHROPIC_API_KEY=test-key" > .env
          echo "OPENAI_API_KEY=test-key" >> .env
          echo "REDIS_URL=redis://localhost:6379" >> .env

      - name: Start Redis
        uses: supercharge/redis-github-action@1.8.1
        with:
          redis-version: 7

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            --maxfail=5 \
            --timeout=30 \
            -v
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || 'test-key' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-key' }}
          REDIS_URL: redis://localhost:6379

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage reports
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: htmlcov/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 60

  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: test  # Run after unit tests pass

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox]
        # Reduce matrix for faster CI; webkit can be added if needed

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Set up test environment
        run: |
          cp .env.example .env || echo "ANTHROPIC_API_KEY=test-key" > .env
          echo "OPENAI_API_KEY=test-key" >> .env
          echo "REDIS_URL=redis://localhost:6379" >> .env
          echo "JWT_SECRET_KEY=test-jwt-secret-key-for-ci" >> .env
          echo "RATE_LIMIT_ENABLED=false" >> .env

      - name: Start Redis
        uses: supercharge/redis-github-action@1.8.1
        with:
          redis-version: 7

      - name: Start backend server
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 10  # Wait for server to start
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || 'test-key' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-key' }}
          REDIS_URL: redis://localhost:6379
          JWT_SECRET_KEY: test-jwt-secret-key-for-ci

      - name: Wait for backend to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8000/health > /dev/null; then
              echo "Backend is ready"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done

      - name: Run Playwright E2E tests
        run: npx playwright test --project=${{ matrix.browser }}
        env:
          TEST_ENV: dev
          CI: true
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || 'test-key' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-key' }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: playwright-results-${{ matrix.browser }}
          path: |
            test-results/
            playwright-results.json
          retention-days: 30

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: playwright-screenshots-${{ matrix.browser }}
          path: test-results/**/*.png
          retention-days: 7

      - name: Upload video recordings on failure
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: playwright-videos-${{ matrix.browser }}
          path: test-results/**/*.webm
          retention-days: 7

  e2e-api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install

      - name: Set up test environment
        run: |
          cp .env.example .env || echo "ANTHROPIC_API_KEY=test-key" > .env
          echo "OPENAI_API_KEY=test-key" >> .env
          echo "REDIS_URL=redis://localhost:6379" >> .env
          echo "JWT_SECRET_KEY=test-jwt-secret-key-for-ci" >> .env
          echo "RATE_LIMIT_ENABLED=false" >> .env

      - name: Start Redis
        uses: supercharge/redis-github-action@1.8.1
        with:
          redis-version: 7

      - name: Start backend server
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 10
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || 'test-key' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-key' }}
          REDIS_URL: redis://localhost:6379
          JWT_SECRET_KEY: test-jwt-secret-key-for-ci

      - name: Wait for backend
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8000/health > /dev/null; then
              echo "Backend is ready"
              break
            fi
            sleep 2
          done

      - name: Run API-only E2E tests
        run: npx playwright test --project=api
        env:
          TEST_ENV: dev
          CI: true

      - name: Upload API test results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: playwright-api-results
          path: |
            playwright-report/
            playwright-results.json
          retention-days: 30
