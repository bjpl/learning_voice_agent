name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy'
        required: true
        type: string
      skip_tests:
        description: 'Skip test suite (emergency deployments only)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'
  REGISTRY: docker.io
  IMAGE_NAME: learning-voice-agent

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.version || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-timeout

      - name: Start Redis
        uses: supercharge/redis-github-action@1.8.1
        with:
          redis-version: 7

      - name: Run critical tests
        run: |
          pytest tests/test_models.py tests/test_config.py tests/security/ \
            --cov=app \
            --cov-fail-under=60 \
            --maxfail=3 \
            --timeout=60 \
            -v \
            --ignore=tests/security/test_twilio_validation.py
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || 'test-key' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-key' }}
          REDIS_URL: redis://localhost:6379
          ENVIRONMENT: testing

      - name: Security scan
        run: |
          pip install safety bandit
          safety check --ignore 70612 || true
          bandit -r app/ -ll -f json -o bandit-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

  build-and-push:
    needs: validate-and-test
    if: always() && (needs.validate-and-test.result == 'success' || inputs.skip_tests)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.version || github.ref }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=production

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.optimized
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VERSION=${{ steps.meta.outputs.version }}
            GIT_SHA=${{ github.sha }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          artifact-name: sbom-production.spdx.json
          output-file: ./sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v5
        with:
          name: sbom-production
          path: ./sbom.spdx.json
          retention-days: 90

  deploy-production:
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 25
    environment:
      name: production
      url: https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli

      - name: Create pre-deployment backup
        id: backup
        run: |
          echo "Creating database backup before deployment..."
          BACKUP_ID="backup-$(date +%Y%m%d-%H%M%S)"
          echo "backup_id=$BACKUP_ID" >> $GITHUB_OUTPUT
          # Railway database backup (if using Railway PostgreSQL)
          # railway run pg_dump > backup_$BACKUP_ID.sql || true
        continue-on-error: true

      - name: Deploy to Railway Production
        id: deploy
        run: |
          railway link ${{ secrets.RAILWAY_PRODUCTION_PROJECT_ID }}
          railway up --detach
          echo "deployment_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for deployment to stabilize
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 60

          # Poll health endpoint until healthy or timeout
          for i in {1..10}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 \
              https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}/health || echo "000")
            if [ "$status" = "200" ]; then
              echo "Health check passed on attempt $i"
              exit 0
            fi
            echo "Attempt $i: Status $status, waiting..."
            sleep 10
          done
          echo "Health check failed after 10 attempts"
          exit 1

      - name: Run deployment verification
        run: |
          chmod +x ./scripts/verify_deployment.sh
          ./scripts/verify_deployment.sh https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}

      - name: Run smoke tests
        run: |
          # Health check
          curl -f https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}/health || exit 1

          # Detailed health
          curl -f https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}/health/detailed || true

          # API stats
          curl -f https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}/api/stats || exit 1

          # Security headers verification
          headers=$(curl -sI https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}/)
          echo "$headers" | grep -i "content-security-policy" || echo "Warning: CSP header missing"
          echo "$headers" | grep -i "x-frame-options" || echo "Warning: X-Frame-Options missing"

          echo "Smoke tests passed"

      - name: Notify deployment success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "PRODUCTION deployment successful",
              attachments: [{
                color: 'good',
                fields: [
                  { title: 'Version', value: '${{ github.event.inputs.version || github.ref }}', short: true },
                  { title: 'Commit', value: '${{ github.sha }}', short: true },
                  { title: 'URL', value: 'https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}', short: false },
                  { title: 'Deployed by', value: '${{ github.actor }}', short: true },
                  { title: 'Image', value: '${{ needs.build-and-push.outputs.image_tag }}', short: true }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Create GitHub deployment record
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              auto_merge: false,
              required_contexts: [],
              description: 'Production deployment via GitHub Actions'
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: 'https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}',
              description: 'Deployment completed successfully'
            });

  rollback:
    needs: deploy-production
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Attempt automatic rollback
        id: rollback
        run: |
          echo "Attempting automatic rollback..."
          railway link ${{ secrets.RAILWAY_PRODUCTION_PROJECT_ID }}

          # Get previous deployment
          # Note: Railway CLI rollback varies by version
          railway rollback --yes 2>/dev/null || echo "Auto-rollback not available"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

      - name: Notify rollback needed
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "PRODUCTION deployment FAILED - ROLLBACK INITIATED",
              attachments: [{
                color: 'danger',
                fields: [
                  { title: 'Status', value: 'FAILED - Manual intervention may be required', short: false },
                  { title: 'Failed Version', value: '${{ github.event.inputs.version || github.ref }}', short: true },
                  { title: 'Commit', value: '${{ github.sha }}', short: true },
                  { title: 'Action Required', value: 'Verify rollback or deploy previous stable version', short: false }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Create failed deployment record
        uses: actions/github-script@v8
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              auto_merge: false,
              required_contexts: [],
              description: 'Failed production deployment'
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'failure',
              description: 'Deployment failed - rollback initiated'
            });
        continue-on-error: true

      - name: Rollback instructions
        run: |
          echo "=============================================="
          echo "ROLLBACK INSTRUCTIONS"
          echo "=============================================="
          echo ""
          echo "1. Railway CLI rollback:"
          echo "   railway rollback --project ${{ secrets.RAILWAY_PRODUCTION_PROJECT_ID }}"
          echo ""
          echo "2. Deploy previous stable version:"
          echo "   git checkout <previous-tag>"
          echo "   railway up"
          echo ""
          echo "3. Docker rollback (if using Docker):"
          echo "   docker pull ${{ secrets.DOCKER_USERNAME }}/learning-voice-agent:<previous-tag>"
          echo "   docker run -d --env-file .env.production learning-voice-agent:<previous-tag>"
          echo ""
          echo "4. Verify health after rollback:"
          echo "   curl https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}/health"
          echo "=============================================="

  # Post-deployment monitoring job
  post-deploy-monitoring:
    needs: deploy-production
    runs-on: ubuntu-latest
    if: success()
    timeout-minutes: 15

    steps:
      - name: Monitor deployment health
        run: |
          echo "Monitoring deployment health for 10 minutes..."

          for i in {1..20}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 \
              https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}/health || echo "000")

            if [ "$status" != "200" ]; then
              echo "Health check failed at minute $((i/2)): HTTP $status"
              echo "health_degraded=true" >> $GITHUB_OUTPUT
            else
              echo "Health check OK at minute $((i/2))"
            fi

            sleep 30
          done

      - name: Check error rates
        run: |
          # Check for elevated error rates via detailed health endpoint
          response=$(curl -s https://${{ secrets.RAILWAY_PRODUCTION_DOMAIN }}/health/detailed || echo '{}')
          echo "Health check response: $response"
        continue-on-error: true
